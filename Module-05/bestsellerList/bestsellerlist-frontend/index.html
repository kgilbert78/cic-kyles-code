<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyle's New York Times Bestseller List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="style.css" /> -->
    <style>
        h3 {
            font-size: 1.25rem;
        }

        .coverImgDiv {
            height: 150px;
        }

        .coverImg {
            max-height: 100%;
        }
    </style>
</head>
<body class="mx-2 my-2">
    <main class="mainContent">
        <h1 id="top">This Week's New York Times Bestseller List</h1>
            <div class="d-flex flex-row">
            <div class="col-9" id="bestsellerLists">
            </div>
            <div class="col-3">
                <div id="navLinks">
                    <h3>Jump to a category:</h3>
                </div>
                <div id="readingList" class="mt-5">
                    <h3>My Reading List</h3>
                    <ul id="list"> <!-- link to updateHTML function with this ID -->
                        
                    </ul> 
                    <button 
                        class="btn btn-sm btn-danger"
                        id="removeButton"
                        onclick="removeButtonPressedInHTML(event)"
                    >
                        Remove button in the html
                    </button>
                </div>
            </div>
           
        </div>
    </main>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://api.nytimes.com/svc/books/v3/lists/overview.json"></script>
<script>
    let bestsellerDiv = document.getElementById("bestsellerLists");
    let promise = axios.get('https://api.nytimes.com/svc/books/v3/lists/overview.json?api-key=YC7F434qQ2icxGUGalXKqVKPXQ0ZqDGv', {headers:{"Accept": "application/json"}});
        promise.then(function(response){
            console.log(response.status);
            let bestsellerData = JSON.stringify(response.data);
            let bestsellerContent = "";

            let categories = response.data.results.lists;
            categories.map((category) => {
                const categoryDiv = document.createElement("div");
                const categoryName = category.display_name;
                const navLinks = document.getElementById("navLinks");
                categoryDiv.className = "categoryDiv mx-2 my-4 border";
                categoryDiv.innerHTML = `<a id="${categoryName}"><h2 class="my-4">${categoryName}</h2></a>`;
                bestsellerContent += categoryDiv.innerHTML;
                let books = category.books;
                books.map((book) => {
                    const bookDiv = document.createElement("div");
                    let title = book.title;
                    let author = book.author;
                    let description = book.description;
                    let coverImg = book.book_image;
                    let amazonLink = book.buy_links[0].url;
                    bookDiv.innerHTML = 
                        `<div class="d-flex flex-row mx-2 my-4">
                            <div class="coverImgDiv col-1">
                                <a href="${amazonLink}" target="_blank">
                                    <img class="coverImg img-fluid" src="${coverImg}" />
                                </a>
                            </div>
                            <div></div>
                            <div class="col-8 mx-2">
                                <div class="titleDiv">
                                    <h3>${book.rank}. ${title}, by ${author}</h3>
                                </div>
                            <div class="descriptionDiv">
                                ${description}
                                </div>
                            </div>
                            <div>
                                <form>
                                    <button type="submit" onclick="addBook(event, '${title.replace(/'/g, "\\'")}', '${author}', '${amazonLink}')"class="btn btn-sm btn-primary">Add to Reading List</button>
                                </form>
                            </div>
                        </div>`
                    bestsellerContent += bookDiv.innerHTML;
                });

                categoryDiv.innerHTML = `<div class="text-center"><a href="#top">Return to top</a></div>`; 
                navLinks.innerHTML += `<div><a href="#${categoryName}">${categoryName}</a></div>`;
                bestsellerContent += categoryDiv.innerHTML;
            });
            bestsellerDiv.innerHTML = bestsellerContent;
        });

    let myReadingList = [];

    const booksFromDB = async () => {
        myReadingList = [];
        const response = await fetch("http://localhost:3006/readinglist");
        const dbData = await response.json();
        dbData.readinglist.map((dbArray, index) => {
            myReadingList.push(dbArray);
            updateHTML();
        });       
        
	};
    booksFromDB();

    const addBook = async (event, newTitle, newAuthor, newAmazonLink) => {
        event.preventDefault();
        
        const response = await fetch(`http://localhost:3006/readinglist`, {
			method: "POST", 
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify({
                title: newTitle, 
                author: newAuthor, 
                amazonLink: newAmazonLink,
                didRead: false
            }),
		});

        window.alert(`${newTitle} has been added to your reading list.`)

        booksFromDB();
    };

    const removeButtonPressed = (event, id, link, title, author) => {
        // Uncaught (in promise) TypeError: Cannot read property 'preventDefault' of undefined... meaning event is undefined
        // at one point I was taking out event.preventDefault and both event parameters and it worked but ran automatically on reload. can't replicate now.
        event.preventDefault();
        if (window.confirm(`Are you sure you want to remove ${title}?`)) {
            console.log("deleting", title)
        };
    };
    const removeButtonPressedInHTML = (event) => {
        event.preventDefault();
        if (window.confirm(`Are you sure you want to remove this book?`)) {
            console.log("deleting the book")
        };
    };

    function updateHTML() {
        const list = document.getElementById("list"); 
        
        let htmlToUpdate = "";

        // if (myReadingList === []) {
        //     htmlToUpdate += `<li>Nothing to read yet!</li>`;
        // } else {
            myReadingList.map((dbArray) => {
                htmlToUpdate += `
                    <li>
                        <a href=${dbArray.amazonLink}>
                            ${dbArray.title}
                        </a>
                        , by ${dbArray.author}
                        ${/* take span out and it loads the readinglist */""}
                        ${/* 
                        <span class="toggleVisibility">
                            <button 
                                class="btn btn-sm btn-success"
                                id="didReadButton"
                            >
                                I read this!
                            </button>
                            <button 
                                class="btn btn-sm btn-danger"
                                id="removeButton"
                                onclick=${removeButtonPressed(event, dbArray.bookID, dbArray.amazonLink, dbArray.title, dbArray.author)}
                            >
                                Remove
                            </button>
                        </span>
                        ${/* */""}
                    </li>`;
            });
        //}
        
        list.innerHTML = htmlToUpdate;
        //console.log(list);
    };

    // TO DO LIST

    // Update delete function for database. Add word remove appearing on hover instead of button.

    // Add "mark as read" on hover that changes the db boolean to true, changes the font color to gray and moves it to the bottom of the list. Pass index for use inside remove function to tell it which array item.
    // <button onclick="readButtonPressed(${book})">I read this!</button>

    // Change window.alert that says the new book was added to window.confirm and account for "cancel" in window? (Run delete function w/o it's pop up confirming delete?)

    // Put category links and reading list in side navbar so you can always see them.

    // Make responsive for mobile

    // Create login system, add users table to db that tracks individual users' reading lists, and make the specific user's reading list appear.

</script>
</html>

